<div class="layout">
  <header>
    <button class="burger" (click)="toggleSidebar()" aria-label="menu">
      ☰
    </button>
    <div class="brand"><span class="logo">⚙️</span> Skynet</div>
    <div class="user">
      <button class="user-btn" (click)="toggleUserMenu($event)">
        <span class="material-icons" aria-hidden="true">account_circle</span>
        <span class="user-name">{{ username() || "Invitado" }}</span>
        <span class="material-icons" aria-hidden="true">expand_more</span>
      </button>
      <div
        class="user-menu"
        *ngIf="userMenuOpen()"
        (click)="$event.stopPropagation()"
      >
        <div class="menu-header">
          Conectado como <b>{{ username() }}</b>
        </div>
        <div class="menu-sub" *ngIf="roles()?.length">
          <span class="role-chip" *ngFor="let r of roles()">{{ r }}</span>
        </div>
        <button class="item" (click)="openChangePassword()">
          <span class="material-icons">lock_reset</span>
          Cambiar contraseña
        </button>
        <button class="item" (click)="refresh()">
          <span class="material-icons">refresh</span>
          Refrescar token
        </button>
        <button class="item danger" (click)="logout($event)">
          <span class="material-icons">logout</span>
          Salir
        </button>
      </div>
    </div>
  </header>
  <div class="body">
    <aside class="side" [class.open]="sidebarOpen()" [class.collapsed]="sidebarCollapsed()">
      <nav>
        <div class="top-actions">
          <button
            class="collapse-control has-tooltip"
            (click)="toggleSidebarCollapse()"
            [attr.aria-pressed]="sidebarCollapsed()"
            [attr.aria-label]="sidebarCollapsed() ? 'Mostrar menú' : 'Ocultar menú'"
            title="{{ sidebarCollapsed() ? 'Mostrar menú' : 'Ocultar menú' }}"
          >
            <span class="material-icons" aria-hidden="true">menu</span>
            <span class="tooltip">{{ sidebarCollapsed() ? 'Mostrar menú' : 'Ocultar menú' }}</span>
          </button>
          <span class="top-title">Sistema de Soporte</span>
        </div>
  <h4>Operaciones</h4>
        <ul>
          <li *ngIf="showGestion()">
            <a
              class="nav-link"
              routerLink="/app/gestion/gestiones"
              routerLinkActive="active"
              title="Gestiones"
              [attr.aria-label]="sidebarCollapsed() ? 'Gestiones' : null"
            >
              <span class="material-icons" aria-hidden="true">assignment</span>
              <span class="label">Gestiones</span>
            </a>
          </li>
          <li *ngIf="isCliente()">
            <a
              class="nav-link"
              routerLink="/app/gestion/mi-cliente"
              routerLinkActive="active"
              title="Mis datos de cliente"
              [attr.aria-label]="sidebarCollapsed() ? 'Mis datos de cliente' : null"
            >
              <span class="material-icons" aria-hidden="true">person</span>
              <span class="label">Mis datos de cliente</span>
            </a>
          </li>
        </ul>
        <h4 *ngIf="showAdmin()">Administración</h4>
        <ul *ngIf="showAdmin()">
          <li>
            <a
              class="nav-link"
              routerLink="/app/gestion/tipos-gestion"
              routerLinkActive="active"
              title="Tipos de Gestión"
              [attr.aria-label]="sidebarCollapsed() ? 'Tipos de Gestión' : null"
            >
              <span class="material-icons" aria-hidden="true">category</span>
              <span class="label">Tipos de Gestión</span>
            </a>
          </li>
          <li>
            <a
              class="nav-link"
              routerLink="/app/gestion/empleados"
              routerLinkActive="active"
              title="Empleados"
              [attr.aria-label]="sidebarCollapsed() ? 'Empleados' : null"
            >
              <span class="material-icons" aria-hidden="true">badge</span>
              <span class="label">Empleados</span>
            </a>
          </li>
          <li>
            <a
              class="nav-link"
              routerLink="/app/gestion/tipos-empleado"
              routerLinkActive="active"
              title="Tipos de Empleado"
              [attr.aria-label]="sidebarCollapsed() ? 'Tipos de Empleado' : null"
            >
              <span class="material-icons" aria-hidden="true">group_work</span>
              <span class="label">Tipos de Empleado</span>
            </a>
          </li>
          <li>
            <a
              class="nav-link"
              routerLink="/app/gestion/clientes"
              routerLinkActive="active"
              title="Clientes"
              [attr.aria-label]="sidebarCollapsed() ? 'Clientes' : null"
            >
              <span class="material-icons" aria-hidden="true">groups</span>
              <span class="label">Clientes</span>
            </a>
          </li>
          <li *ngIf="showUsuarios()">
            <a
              class="nav-link"
              routerLink="/app/seguridad/usuarios"
              routerLinkActive="active"
              title="Usuarios"
              [attr.aria-label]="sidebarCollapsed() ? 'Usuarios' : null"
            >
              <span class="material-icons" aria-hidden="true">person</span>
              <span class="label">Usuarios</span>
            </a>
          </li>
          <li *ngIf="showRoles()">
            <a
              class="nav-link"
              routerLink="/app/seguridad/roles"
              routerLinkActive="active"
              title="Roles"
              [attr.aria-label]="sidebarCollapsed() ? 'Roles' : null"
            >
              <span class="material-icons" aria-hidden="true">security</span>
              <span class="label">Roles</span>
            </a>
          </li>
        </ul>
      </nav>
    </aside>
    <main class="content">
      <router-outlet></router-outlet>
    </main>
  </div>
  <!-- Backdrop para menú móvil -->
  <div class="backdrop" *ngIf="sidebarOpen()" (click)="toggleSidebar()"></div>
  <footer>
    Universidad Mariano Galvez, Facultad de Ingeniería en Sistemas — Derechos
    reservados 2025
  </footer>

  <!-- Modal Cambiar Contraseña (reutilizado) -->
  <app-change-password-dialog
    [open]="changePwdOpen()"
    (close)="closeChangePassword()"
    (submit)="submitChangePassword($event)"
  />
</div>
