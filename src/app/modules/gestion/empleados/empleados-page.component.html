<div class="toolbar">
  <h2>Empleados</h2>
  <button class="btn" *ngIf="canEdit()" (click)="openCreate()">
    <span class="material-icons" aria-hidden="true">add</span>
    Crear
  </button>
</div>

<div class="table-wrapper">
  <table class="tbl">
    <thead>
      <tr>
        <th class="options-col">
          <span class="material-icons" title="Menú de opciones">more_horiz</span>
        </th>
        <th>Nombres</th>
        <th>Apellidos</th>
        <th>Tipo</th>
        <th>Teléfono</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let e of empleados()">
        <td class="options-col">
          <app-action-menu
            [canView]="true"
            [canEdit]="canEdit()"
            [canDelete]="canDelete()"
            [canAssignTecnicos]="canEdit() && isSupervisorTipo(e.idEmpleadoTipo)"
            (view)="openView(e)"
            (edit)="openEdit(e)"
            (remove)="remove(e)"
            (assignTecnicos)="openAsignar(e)"
          ></app-action-menu>
        </td>
        <td>{{ e.nombres }}</td>
        <td>{{ e.apellidos }}</td>
        <td>{{ empleadoTipoNombre(e.idEmpleadoTipo) }}</td>
        <td>{{ e.telefono }}</td>
      </tr>
    </tbody>
  </table>
</div>

<app-modal [open]="modalOpen()" [title]="modalTitle()" (close)="closeModal()">
  <div *ngIf="modalMode() !== 'view'" class="form">
    <label>Nombres <input [(ngModel)]="draft.nombres" required /></label>
    <label>Apellidos <input [(ngModel)]="draft.apellidos" required /></label>
    <label
      >Tipo de Empleado
      <select [(ngModel)]="draft.idEmpleadoTipo">
        <option *ngFor="let t of tipos()" [ngValue]="t.id">
          {{ t.nombre }}
        </option>
      </select>
    </label>
    <div class="full-row" *ngIf="modalMode() === 'edit' && isSupervisorTipo(draft.idEmpleadoTipo)">
      <button class="btn" (click)="openAsignar(draft)">
        <span class="material-icons" aria-hidden="true">group_add</span>
        Asignar técnicos
      </button>
    </div>
    <label>Teléfono <input [(ngModel)]="draft.telefono" /></label>
    <label>Dirección <input [(ngModel)]="draft.direccion" /></label>
  </div>
  <div *ngIf="modalMode() === 'view'">
    <p><b>Nombres:</b> {{ draft.nombres }}</p>
    <p><b>Apellidos:</b> {{ draft.apellidos }}</p>
    <p><b>Tipo:</b> {{ empleadoTipoNombre(draft.idEmpleadoTipo) }}</p>
    <p><b>Teléfono:</b> {{ draft.telefono }}</p>
    <p><b>Dirección:</b> {{ draft.direccion }}</p>
  </div>
  <div modal-actions class="actions-row">
    <button class="btn" *ngIf="modalMode() !== 'view'" (click)="save()">
      <span class="material-icons" aria-hidden="true">save</span>
      Guardar
    </button>
    <button class="btn outline" (click)="closeModal()">
      <span class="material-icons" aria-hidden="true">close</span>
      Cancelar
    </button>
  </div>
</app-modal>

<app-modal [open]="asignacionOpen()" [title]="'Asignar técnicos a ' + (asignacionSupervisor?.nombres || '')" (close)="closeAsignar()">
  <div class="form">
    <div class="full-row" style="grid-column:1 / -1">
      <p>Marca los técnicos que estarán a cargo del supervisor.</p>
    </div>
    <div class="full-row" style="grid-column:1 / -1; max-height: 300px; overflow:auto; border:1px solid #eee; border-radius:6px; padding:8px;">
      <label *ngFor="let t of tecnicos()" style="display:flex; align-items:center; gap:8px; margin:4px 0;">
        <input type="checkbox" [checked]="seleccionTecnicos.has(t.id!)" (change)="toggleTecnico(t.id!, $event.target.checked)" />
        <span>{{ t.nombres }} {{ t.apellidos }}</span>
      </label>
    </div>
  </div>
  <div modal-actions class="actions-row">
    <button class="btn" (click)="saveAsignaciones()"><span class="material-icons">save</span> Guardar</button>
    <button class="btn outline" (click)="closeAsignar()"><span class="material-icons">close</span> Cancelar</button>
  </div>
</app-modal>
