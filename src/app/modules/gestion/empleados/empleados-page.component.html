<div class="toolbar">
  <h2>Empleados</h2>
  <button class="btn" *ngIf="canEdit()" (click)="openCreate()">
    <span class="material-icons" aria-hidden="true">add</span>
    Crear
  </button>
</div>

<div class="table-wrapper">
  <table class="tbl">
    <thead>
      <tr>
        <th class="options-col">
          <span class="material-icons" title="Menú de opciones">more_horiz</span>
        </th>
        <th>Nombres</th>
        <th>Apellidos</th>
        <th>Tipo</th>
        <th>Teléfono</th>
        <th>Usuario</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let e of empleados()">
        <td class="options-col">
          <app-action-menu
            [canView]="true"
            [canEdit]="canEdit()"
            [canDelete]="canDelete()"
            [canAssignTecnicos]="canEdit() && isSupervisorTipo(e.idEmpleadoTipo)"
            (view)="openView(e)"
            (edit)="openEdit(e)"
            (remove)="remove(e)"
            (assignTecnicos)="openAsignar(e)"
          ></app-action-menu>
        </td>
        <td>{{ e.nombres }}</td>
        <td>{{ e.apellidos }}</td>
        <td>{{ empleadoTipoNombre(e.idEmpleadoTipo) }}</td>
        <td>{{ e.telefono }}</td>
        <td>{{ usuarioNombre(e.idUsuario) }}</td>
      </tr>
    </tbody>
  </table>
</div>

<app-modal [open]="modalOpen()" [title]="modalTitle()" [size]="'xl'" (close)="closeModal()">
  <div *ngIf="modalMode() !== 'view'" class="form grid-2">
    <label>
      Nombres
      <input [(ngModel)]="draft.nombres" required />
    </label>
    <label>
      Apellidos
      <input [(ngModel)]="draft.apellidos" required />
    </label>
    <label
      >Tipo de Empleado
      <select [(ngModel)]="draft.idEmpleadoTipo">
        <option *ngFor="let t of tipos()" [ngValue]="t.id">
          {{ t.nombre }}
        </option>
      </select>
    </label>
    <label>
      Usuario Asociado
      <select [(ngModel)]="draft.idUsuario" [disabled]="loadingUsuarios() || usuarios().length === 0">
        <option [ngValue]="null">Sin usuario asignado</option>
        <option *ngFor="let u of usuarios()" [ngValue]="u.id">
          {{ usuarioNombre(u.id) }} <span *ngIf="u.username">({{ u.username }})</span>
        </option>
      </select>
      <div class="inline-hint" *ngIf="loadingUsuarios()">
        <span class="spinner"></span> Cargando usuarios...
      </div>
      <small class="hint warning" *ngIf="usuarios().length === 0">
        No hay usuarios disponibles para asociar. Verifica el microservicio principal.
      </small>
    </label>
    <div class="full-row" *ngIf="modalMode() === 'edit' && isSupervisorTipo(draft.idEmpleadoTipo)">
      <button class="btn" (click)="openAsignar(draft)">
        <span class="material-icons" aria-hidden="true">group_add</span>
        Asignar técnicos
      </button>
    </div>
    <label>
      Teléfono
      <input [(ngModel)]="draft.telefono" />
    </label>
    <label class="full-row">
      Dirección
      <input [(ngModel)]="draft.direccion" />
    </label>
    <hr class="section-divider full-row" />
    <div class="audit full-row">
      <div class="audit-grid">
        <label>
          Fecha Creación
          <input [value]="draft.fechaCreacion ? (draft.fechaCreacion | date:'dd/MM/yyyy HH:mm') : '—'" disabled />
        </label>
        <label>
          Fecha Modificación
          <input [value]="draft.fechaModificacion ? (draft.fechaModificacion | date:'dd/MM/yyyy HH:mm') : '—'" disabled />
        </label>
        <label>
          Usuario Creador
          <input [value]="creatorNombre() || (draft.idUsuarioCreador ? ('ID ' + draft.idUsuarioCreador) : '—')" disabled />
        </label>
      </div>
    </div>
  </div>
  <div *ngIf="modalMode() === 'view'" class="view-block">
    <p><b>Nombres:</b> {{ draft.nombres }}</p>
    <p><b>Apellidos:</b> {{ draft.apellidos }}</p>
    <p><b>Tipo:</b> {{ empleadoTipoNombre(draft.idEmpleadoTipo) }}</p>
    <p><b>Usuario Asociado:</b> {{ usuarioNombre(draft.idUsuario) }}</p>
    <p><b>Teléfono:</b> {{ draft.telefono }}</p>
    <p><b>Dirección:</b> {{ draft.direccion }}</p>
    <hr />
    <p><b>Fecha Creación:</b> {{ draft.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}</p>
    <p><b>Fecha Modificación:</b> {{ draft.fechaModificacion | date:'dd/MM/yyyy HH:mm' }}</p>
  <p><b>Usuario Creador:</b> {{ creatorNombre() || (draft.idUsuarioCreador ? ('ID ' + draft.idUsuarioCreador) : '—') }}</p>
  </div>
  <div modal-actions class="actions-row">
    <button class="btn" *ngIf="modalMode() !== 'view'" (click)="save()">
      <span class="material-icons" aria-hidden="true">save</span>
      Guardar
    </button>
    <button class="btn outline" (click)="closeModal()">
      <span class="material-icons" aria-hidden="true">close</span>
      Cancelar
    </button>
  </div>
</app-modal>

<app-modal [open]="asignacionOpen()" [title]="'Asignar técnicos a ' + (asignacionSupervisor?.nombres || '')" (close)="closeAsignar()">
  <div class="form">
    <div class="full-row" style="grid-column:1 / -1">
      <p>Marca los técnicos que estarán a cargo del supervisor.</p>
    </div>
    <div class="full-row" style="grid-column:1 / -1; max-height: 300px; overflow:auto; border:1px solid #eee; border-radius:6px; padding:8px;">
      <label *ngFor="let t of tecnicos()" style="display:flex; align-items:center; gap:8px; margin:4px 0;">
        <input type="checkbox" [checked]="seleccionTecnicos.has(t.id!)" (change)="toggleTecnico(t.id!, $event.target.checked)" />
        <span>{{ t.nombres }} {{ t.apellidos }}</span>
      </label>
    </div>
  </div>
  <div modal-actions class="actions-row">
    <button class="btn" (click)="saveAsignaciones()"><span class="material-icons">save</span> Guardar</button>
    <button class="btn outline" (click)="closeAsignar()"><span class="material-icons">close</span> Cancelar</button>
  </div>
</app-modal>
