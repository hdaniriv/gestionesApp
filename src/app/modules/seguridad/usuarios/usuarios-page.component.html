<div class="toolbar">
  <h2>Usuarios</h2>
  <button class="btn" *ngIf="canEdit()" (click)="openCreate()">
    <span class="material-icons" aria-hidden="true">add</span>
    Crear
  </button>
</div>

<div class="table-wrapper">
  <table class="tbl">
    <thead>
      <tr>
        <th class="options-col">
          <span class="material-icons" title="Menú de opciones"
            >more_horiz</span
          >
        </th>
        <th>Usuario</th>
        <th>Nombre</th>
        <th>Email</th>
        <th>Activo</th>
        <th>Roles</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let u of usuarios()">
        <td class="options-col">
          <app-action-menu
            [canView]="true"
            [canEdit]="canEdit()"
            [canDelete]="canDelete()"
            [canRoles]="canEdit()"
            [canChangePassword]="auth.userSig()?.username === u.username"
            [canResetPassword]="canEdit()"
            (view)="openView(u)"
            (edit)="openEdit(u)"
            (remove)="remove(u)"
            (roles)="openRoles(u)"
            (changePassword)="openChangePassword(u)"
            (resetPassword)="openResetPassword(u)"
          ></app-action-menu>
        </td>
        <td>{{ u.username }}</td>
        <td>{{ u.nombre }}</td>
        <td>{{ u.email }}</td>
        <td><input type="checkbox" [checked]="u.activo" disabled /></td>
        <td class="roles-col">
          <ng-container *ngIf="rolesFor(u)?.length; else noRoles">
            <span *ngFor="let r of rolesFor(u); let last = last">
              {{ r }}<span class="sep" *ngIf="!last"> | </span>
            </span>
          </ng-container>
          <ng-template #noRoles>-</ng-template>
        </td>
      </tr>
    </tbody>
  </table>
</div>

<!-- Modal CRUD Usuario -->
<app-modal [open]="modalOpen()" [title]="modalTitle()" (close)="closeModal()">
  <div *ngIf="modalMode() !== 'view'" class="form" autocomplete="off">
    <label
      >Usuario <input [(ngModel)]="draft.username" required minlength="3" autocomplete="off" autocapitalize="off" spellcheck="false" name="create-username"
    /></label>
    <label>Nombre <input [(ngModel)]="draft.nombre" autocomplete="off" name="create-nombre" /></label>
    <label>Email <input type="email" [(ngModel)]="draft.email" autocomplete="off" name="create-email" /></label>
    <label>Activo <input type="checkbox" [(ngModel)]="draft.activo" /></label>

    <!-- Campos adicionales solo para creación -->
    <ng-container *ngIf="modalMode() === 'create'">
      <label>
        Nueva contraseña
        <input type="password" [(ngModel)]="createPassword" minlength="6" required autocomplete="new-password" name="create-password" />
      </label>
      <div *ngIf="createPassword && createPassword.length < 6" class="hint error">
        La contraseña debe tener al menos 6 caracteres
      </div>
      <label>
        Confirmar contraseña
        <input type="password" [(ngModel)]="createPassword2" minlength="6" required autocomplete="new-password" name="create-password-confirm" />
      </label>
      <div *ngIf="createPassword && createPassword2 && createPassword !== createPassword2" class="hint error">
        Las contraseñas no coinciden
      </div>
      <label>
        Rol inicial
        <select [(ngModel)]="createRoleId" required>
          <option [ngValue]="null" disabled selected>Selecciona un rol…</option>
          <option *ngFor="let r of allRoles()" [ngValue]="r.id">{{ r.nombre }}</option>
        </select>
      </label>
      <div *ngIf="createRoleId === null" class="hint error">
        Debes seleccionar un rol para el usuario
      </div>

      <!-- Requisitos mínimos -->
      <ul class="reqs" *ngIf="!canSubmitCreate()">
        <li *ngIf="!draft.username || draft.username.trim().length < 3">Usuario: mínimo 3 caracteres</li>
        <li *ngIf="!createPassword || createPassword.length < 6">Contraseña: mínimo 6 caracteres</li>
        <li *ngIf="createPassword && createPassword2 && createPassword !== createPassword2">Las contraseñas deben coincidir</li>
        <li *ngIf="createRoleId === null">Selecciona un rol inicial</li>
      </ul>
    </ng-container>
  </div>
  <div *ngIf="modalMode() === 'view'">
    <p><b>Usuario:</b> {{ draft.username }}</p>
    <p><b>Nombre:</b> {{ draft.nombre }}</p>
    <p><b>Email:</b> {{ draft.email }}</p>
    <p><b>Activo:</b> {{ draft.activo ? "Sí" : "No" }}</p>
  </div>
  <div modal-actions class="actions-row">
    <button
      class="btn"
      *ngIf="modalMode() !== 'view'"
      [disabled]="modalMode() === 'create' && !canSubmitCreate()"
      (click)="save()"
    >
      <span class="material-icons" aria-hidden="true">save</span>
      Guardar
    </button>
    <button class="btn outline" (click)="closeModal()">
      <span class="material-icons" aria-hidden="true">close</span>
      Cancelar
    </button>
  </div>
</app-modal>

<!-- Modal Cambiar Contraseña (reutilizado) -->
<app-change-password-dialog
  [open]="changePwdOpen()"
  [title]="'Cambiar contraseña de ' + (changePwdUser?.username || '')"
  (close)="closeChangePassword()"
  (submit)="submitChangePassword($event)"
/>

<!-- Modal Resetear Contraseña (solo admin) -->
<app-reset-password-dialog
  [open]="resetPwdOpen()"
  [title]="'Resetear contraseña de ' + (resetPwdUser?.username || '')"
  (close)="closeResetPassword()"
  (submit)="submitResetPassword($event)"
/>

<!-- Modal Roles de Usuario -->
<app-modal
  [open]="rolesModalOpen()"
  [title]="rolesModalTitle()"
  (close)="closeRolesModal()"
>
  <div class="grid">
    <div>
      <h4>Asignados</h4>
      <ul>
        <li *ngFor="let r of assignedRoles()">
          {{ r.nombre }}
          <button
            class="link danger"
            *ngIf="canEdit()"
            (click)="removeRoleFromCurrent(r)"
          >
            Quitar
          </button>
        </li>
        <li *ngIf="assignedRoles().length === 0">Sin roles</li>
      </ul>
    </div>
    <div>
      <h4>Disponibles</h4>
      <ul>
        <li *ngFor="let r of availableRoles()">
          {{ r.nombre }}
          <button
            class="link"
            *ngIf="canEdit()"
            (click)="assignRoleToCurrent(r)"
          >
            Asignar
          </button>
        </li>
        <li *ngIf="availableRoles().length === 0">Sin roles para asignar</li>
      </ul>
    </div>
  </div>
  <div modal-actions class="actions-row">
    <button class="btn outline" (click)="closeRolesModal()">
      <span class="material-icons" aria-hidden="true">close</span>
      Cerrar
    </button>
  </div>
</app-modal>
